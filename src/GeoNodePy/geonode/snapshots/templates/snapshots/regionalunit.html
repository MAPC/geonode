{% extends "mbdc/base.html" %}

{% load mbdc_extras %}
{% load snapshots_extras %}


{% block title %}{{ regionalunit.name }} Community Snapshot | {{ block.super }}{% endblock %}


{% block extra_css %}
<link href="{{ STATIC_URL }}snapshots/chosen/chosen.css" rel="stylesheet" type="text/css" />
{% endblock extra_css %}


{% block head_javascript %}

{{ block.super }}

{% include "weave/_swfobject.html" %}

<script language="JavaScript" src="{{ STATIC_URL }}snapshots/chosen/chosen.jquery.min.js" type="text/javascript"></script>


<script type="text/javascript">

// keeping track of which visualization is currently shown and loaded
var pagevis = {};

{% if overviewmap %}

jQuery(document).ready(function($) {

	pagevis["overviewmap"] = {
		visid: {{ overviewmap.id }}
	}

{% if overviewmap.id not in tn_list %}

	$(".view_print").hide();

    // add featured Weave Flash object
    swfobject.embedSWF(
      "{{ WEAVE_URL }}weave.swf", 
      "overviewmap", 
      "380", "275", 
      "10.0.0",
      "expressInstall.swf", 
      {
		file: "{{ SITEURL|slice:':-1' }}{% url geonode.snapshots.views.get_sessionstate regiontype.slug regionalunit.slug overviewmap.id %}"
	  }, 
      MBDC.swfobject.params, 
      {
        id: "overviewmap",
        name: "overviewmap"
      }
    );

    pagevis["overviewmap"].loaded = false;

{% endif %}

    // Flash available
	if (swfobject.getFlashPlayerVersion()["major"] > 0) $("#overviewmap p:first").remove();

});
{% endif %}

// called when Weave JavaScript API is ready
var weaveReady = function(weave) { 

	// session state cosmetics on all instances
	weave.setSessionState(['WeaveProperties'], { 
		backgroundColor: "16777215", // white
		dashboardMode: true, 
		enableMenuBar: false,
		enableToolControls: false ,
		showCopyright: false
	});

	// call weave internal function
	if (weave.id === "overviewmap") weave.evaluateExpression(['MapTool'], 'zoomToSelection()');

	// track loaded visualizations
	pagevis[weave.id].loaded = true;
	var vis, progress = [];
	for (var vis in pagevis) {
		progress.push(pagevis[vis].loaded);
	}
	// all Weave instances loaded
	if (jQuery.inArray(false, progress) === -1) { jQuery(".view_print").show(); }

}

</script>


{% endblock head_javascript %}

{% block body %}
	
<!-- breadcrumb -->
<div class="breadcrumb">
	<span class="breadcrumb_title">You are here:</span>
    <a class="breadcrumb_link" href="/">Home</a>
    <a class="breadcrumb_link" href="/snapshots/{{ regiontype.slug }}">Community Snapshots</a>
    <a class="breadcrumb_link" href="/snapshots/{{ regiontype.slug }}">{{ regiontype.name }}</a>
    <span class="breadcrumb_current">{{ regionalunit.name }}</span>
</div>
<!-- /breadcrumb -->

		
{% get_data_search_bar %}

		
		<!-- site_body -->
		<div class="site_body">
			<div class="site_body_pad">
				<!-- location_content -->
				<div class="location_content">
					
				
					<div class="location_content_media">
						
						{% if overviewmap %}
						<div id="overviewmap">
							{% if overviewmap.id in tn_list %}
							<img src="{{ MEDIA_URL }}snapshots_thumbnails/{{ regiontype.slug }}/{{ regionalunit.slug }}/{{ overviewmap.id }}.png" width="333" height="252" alt="{{ regionalunit.name }} Overviewmap" />
							{% endif %}
                            <p>Please install the <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to interact with this visualization.</p>
                        </div>
                        {% endif %}

                        <div class="city_town_content_select">
							<div class="city_town_content_select_pad">
								<select class="regionalunit_selector chzn-select" id="{{ regiontype.slug }}" style="width:300px;" >
									<option value=""></option>
								{% for runit in regionalunits %}
									<option value="{{ runit.slug }}">{{ runit.name }}</option>
								{% endfor %}
								</select>
							</div>
						</div>
						
					</div>

					<div class="location_content_text page_content">
						
						<h1>{{ regionalunit.name }}</h1>
						{% if regionalunit.short_desc %}{{ regionalunit.short_desc }}{% endif %}

						<!-- printer friendly page -->
						<div class="view_print">
						<a href="print">View Printer-friendly page</a>
						</div>
						<!-- printer friendly page -->
						
					</div>				
					
					<div class="clear"></div>
				</div>
				<!-- /location_content -->
				
				<!-- data_set_listing -->
				<div class="data_set_listing">
					<div class="data_set_listing_pad">

					{% for topic in topics %}
						
						{% get_visualizations topic regiontype regionalunit tn_list %}

					{% endfor %}

						<div class="clear"></div>
					</div>
				</div>
				<!-- /data_set_listing -->

				<!-- printer friendly page -->
				<div class="view_print bottom">
				<a href="print">View Printer-friendly page</a>
				</div>
				<!-- printer friendly page -->
				
			</div>
		</div>
		<!-- /site_body -->
	
{% endblock body %}

{% block extra_javascript %}

{{ block.super }}

<script type="text/javascript">

jQuery(document).ready(function($) {

	/* 
	 * Render selected visualization
	 */
	$(".vis_change").change(function() {

		// only if something other than the first (empty) is selected
		if ($(this).prop("selectedIndex") !== 0) {

			var visparams = $("option:selected", this).data("visparams");

			var weave = swfobject.getObjectById(visparams.topic);

			if (weave === null) {
				// add Flash object
				swfobject.embedSWF(
					"{{ WEAVE_URL }}weave.swf", 
					visparams.topic, 
					"333", "252", 
					"10.0.0",
					"expressInstall.swf", 
					{
						file: visparams.url
					}, 
					MBDC.swfobject.params, 
					{
						id: visparams.topic,
						name: visparams.topic
					}
				);
				pagevis[visparams.topic].loaded = false;
				weave = swfobject.getObjectById(visparams.topic)

			} else {
				// Flash object there, update configuration
				$.get(visparams.url, function(xmlData){

					// Weave API method only accepts strings
					var data = XMLToString(xmlData);
					var sessionstate = weave.convertSessionStateXMLToObject(data);
					weave.setSessionState([], sessionstate);

					// session state cosmetics on all instances
					weave.setSessionState(['WeaveProperties'], { 
						backgroundColor: "16777215", // white
						dashboardMode: true, 
						enableMenuBar: false,
						enableToolControls: false ,
						showCopyright: false
					});
	
				});
			}

			// update title, years and source
			$("#" + visparams.topic + "-meta .title")
				.html("<a href=''>" + visparams.vistitle + "</a>");
			$("#" + visparams.topic + "-meta .info")
			 	.html("Year(s): " + visparams.year + "  <span class='spacer'>&#8226;</span>  Source: " + visparams.sources);	
			 	
			pagevis[visparams.topic].visid = visparams.visid;
		}
	});

	/* 
	 * Turn static image into interactive Visualization
	 */
	$(".vistn").bind("click", function() {
		var weavecont = $(this).parent().attr("id");

		// add Flash object
		swfobject.embedSWF(
			"{{ WEAVE_URL }}weave.swf", 
			weavecont, 
			"333", "252", 
			"10.0.0",
			"expressInstall.swf", 
			MBDC.swfobject.vis[weavecont].flashvars, 
			MBDC.swfobject.params, 
			MBDC.swfobject.vis[weavecont].attributes
		);
		pagevis[weavecont].loaded = false;
	})
	.hover(function() {
    	$(this).css("cursor", "pointer");
  	});


	// XML to string conversion
	// TODO make function globally available
	var XMLToString = function (oXML) {
		if (window.ActiveXObject) {
			return oXML.xml;
		} else {
			return (new XMLSerializer()).serializeToString(oXML);
		}
	}

	/* 
	 * Chosen Regionalunit combobox
	 */
	// initiate
	$(".chzn-select").data("placeholder","See another City or Town").chosen();

    // Open selected snapshot
    $('.regionalunit_selector').change(function() {  	
    	// regionalunit_url = $("option:selected", this).val();
		window.location = "{% url snapshots-regiontype regiontype_slug %}" + regionalunit_url;
		return false;
    });

    /* 
	 * Save thumbnails to server and open print-optimized page with currently shown visualizations
	 */
    $(".view_print a").bind("click", function() {

    	$("object").each( function(index) {
    		var weave = swfobject.getObjectById($(this).attr('id'));
    		try {
				pagevis[weave.id].thumbnail = weave.evaluateExpression(null, 'getBase64Image(Application.application.visDesktop)', null, ['weave.utils.BitmapUtils', 'mx.core.Application']);
			} catch (error) {
				alert("Please wait until all visualizations are loaded.")
			}
    	});

    	$.post("{% url snapshots-thumbnails regiontype_slug=regiontype.slug regionalunit_slug=regionalunit.slug %}", 
			{
				visualizations: JSON.stringify(pagevis)
			},
			function(data){
				// thumbnails created, now open print layout with shown visualizations
				var printvis = [];
				for (var vis in pagevis) {
					printvis.push([pagevis[vis].visid]);
				}
				window.location = "{% url snapshots-print regiontype_slug=regiontype.slug regionalunit_slug=regionalunit.slug %}?visualizations=" + printvis.toString();
			}, 
			"json"
		);

    	return false;
    });

});
	  
</script>

{% endblock extra_javascript %}