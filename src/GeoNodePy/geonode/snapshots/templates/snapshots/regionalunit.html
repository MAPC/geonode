{% extends "mbdc/base.html" %}

{% load mbdc_extras %}
{% load snapshots_extras %}

{% block head_javascript %}

{{ block.super }}

{% include "weave/_swfobject.html" %}

<script type="text/javascript">


// called when Weave JavaScript API is ready
var weaveReady = function(weave) { 

	if (weave.id === "overviewmap") weave.evaluateExpression(['MapTool'], 'zoomToSelection()');

}

jQuery(document).ready(function($) {

    // add featured Weave Flash object
    swfobject.embedSWF(
      "{{ WEAVE_URL }}weave.swf", 
      "overviewmap", 
      "380", "275", 
      "10.0.0",
      "expressInstall.swf", 
      {
		file: "{{ SITEURL|slice:':-1' }}{% url geonode.snapshots.views.get_sessionstate regiontype.slug regionalunit.slug overviewmap.id %}"
	  }, 
      MBDC.swfobject.params, 
      {
        id: "overviewmap",
        name: "overviewmap"
      }
    );

});

</script>

{% endblock head_javascript %}

{% block body %}
	
<!-- breadcrumb -->
<div class="breadcrumb">
	<span class="breadcrumb_title">You are here:</span>
    <a class="breadcrumb_link" href="/">Home</a>
    <a class="breadcrumb_link" href="/snapshots/{{ regiontype.slug }}">Snapshots and Profiles</a>
    <a class="breadcrumb_link" href="/snapshots/{{ regiontype.slug }}">{{ regiontype.name }}</a>
    <span class="breadcrumb_current">{{ regionalunit.name }}</span>
</div>
<!-- /breadcrumb -->

		
{% get_data_search_bar %}

		
		<!-- site_body -->
		<div class="site_body">
			<div class="site_body_pad">
				<!-- location_content -->
				<div class="location_content">
					<div class="location_content_media">

						<div id="overviewmap">
                            <p>Please install the <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to be able to see this visualization.</p>
                        </div>
						
					</div>
					<div class="location_content_text page_content">
						
						<h1>{{ regionalunit.name }}</h1>
						{% if regionalunit.short_desc %}{{ regionalunit.short_desc }}{% endif %}
						
					</div>
					<div class="clear"></div>
				</div>
				<!-- /location_content -->
				
				<!-- data_set_listing -->
				<div class="data_set_listing">
					<div class="data_set_listing_pad">

					{% for topic in topics %}
						
						{% get_visualizations topic regiontype regionalunit %}

					{% endfor %}

					
						
						<div class="clear"></div>
					</div>
				</div>
				<!-- /data_set_listing -->
				
			</div>
		</div>
		<!-- /site_body -->
	
{% endblock body %}

{% block extra_javascript %}

{{ block.super }}

{% include "weave/_swfobject.html" %}

<script type="text/javascript">

jQuery(document).ready(function($) {

	/* 
	* Render selected visualization
	*/
	$(".vis_change").change(function() {

		// only if something other than the first (empty) is selected
		if ($(this).prop("selectedIndex") !== 0) {

			// flash-object-id|FlashVars-file-value|title|year|sources
			var vis_args = $("option:selected", this)
				.val()
				.split("|");

			var weave = swfobject.getObjectById(vis_args[0]);

			$.get(vis_args[1], function(xmlData){

				// XML to string conversion
				// TODO make function globally available
				function XMLToString(oXML) {
					if (window.ActiveXObject) {
						return oXML.xml;
					} else {
						return (new XMLSerializer()).serializeToString(oXML);
					}
				}

				// Weave API method only accepts strings
				var data = XMLToString(xmlData);
				var sessionstate = weave.convertSessionStateXMLToObject(data);
				weave.setSessionState([], sessionstate);

				// session state cosmetics
				weave.setSessionState(['WeaveProperties'], { 
					backgroundColor: "16777215", // white
					dashboardMode: true, 
					enableMenuBar: false,
					enableToolControls: false ,
					showCopyright: false
				});

				// update title, years and source
				$("#" + vis_args[0] + "-meta .title")
					.html("<a href=''>" + vis_args[2] + "</a>");
				$("#" + vis_args[0] + "-meta .info")
				 	.html("Year(s): " + vis_args[3] + "  <span class='spacer'>&#8226;</span>  Source: " + vis_args[4]);		
			});
		}
	});

});
	  
</script>

{% endblock extra_javascript %}