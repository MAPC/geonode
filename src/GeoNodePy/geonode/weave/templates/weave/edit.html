{% extends "mbdc/base.html" %}


{% load i18n %}
{% load mbdc_extras %}


{% block head_javascript %}

{{ block.super }}

{% include "weave/_swfobject.html" %}

<script type="text/javascript">

	// called when Weave JavaScript API is ready
	var weaveReady = function(weave) { 

		{% if visualization.id %}
			// visual AJAX feedback
			jQuery("#spinner").spin("small");
			// load session state for existing visualization
			jQuery.getJSON("{{ visualization.get_absolute_url }}sessionstate",
				function (data) {
					weave.setSessionState([], data);
					// visual cosmetics
					weave.setSessionState(["WeaveProperties"], { 
						backgroundColor: "16777215", // white 
						showCopyright: false
					});
					jQuery("#spinner").spin(false);
				}
			);
		{% endif %}

		// visual cosmetics
		weave.setSessionState(["WeaveProperties"], { 
			backgroundColor: "16777215", // white 
			showCopyright: false
		});
	}

	jQuery(document).ready(function($) {

		// FlashVars and attributes
		MBDC.swfobject.vis["vis-{{ visualization.id|default:'new' }}"] = {
			flashvars: {},
			attributes: {
				id: "vis-{{ visualization.id|default:'new' }}",
				name: "vis-{{ visualization.id|default:'new' }}"
			}
		};

		{% if not visualization.id %}
		$("#duplicate-button, #duplicate-spacer, #embed-button, #embed-spacer, #delete-button, #delete-spacer").hide();
		{% else %}
		MBDC.visid = "{{ visualization.id }}";
		{% endif %}

		// post url
		{% if perm_change %}
		MBDC.visembedurl = MBDC.visurl = "{{ visualization.get_absolute_url }}";
		{% else %}
		// FIXME: security by obscurity
		MBDC.visurl = "{% url weave-new %}";
		$("#properties-button, #save-button, #duplicate-spacer, #delete-button, #delete-spacer").hide();
		{% endif %}

		// init embed-code
		$("#embed-code input").val("<iframe width='500' height='350' frameborder='0' scrolling='no' marginheight='0' marginwidth='0' src='{{ siteurl }}{{ visualization.get_absolute_url }}embed'></iframe><br /><small><a href='{{ siteurl }}{{ visualization.get_absolute_url }}'>View Larger Visualization</a></small>");

		// add Weave Flash object
		swfobject.embedSWF(
			"{{ WEAVE_URL }}weave.swf", 
			"vis-{{ visualization.id|default:'new' }}", 
			"100%", "620", 
			"10.0.0",
			"expressInstall.swf", 
			MBDC.swfobject.vis["vis-{{ visualization.id|default:'new' }}"].flashvars, 
			MBDC.swfobject.params, 
			MBDC.swfobject.vis["vis-{{ visualization.id|default:'new' }}"].attributes
		);

		// Save Visualization
		$("#save-button, #save-properties-button").bind("click", function() {
			saveSessionState();
			return false;
		});

		// Duplicate Visualization
		$("#duplicate-button").bind("click", function() {
			MBDC.visurl = "{% url weave-new %}";
			// pass the current visualization as original if duplicate action
			saveSessionState({"original": MBDC.visid});
			return false;
		});

		// Show Embed-code
		$("#embed-button").toggle(function() {
			$("#embed-code").show();
			return false;
			}, function () {
			$("#embed-code").hide();
			return false;
		});

		var saveSessionState = function (add_params) {

			// visual AJAX feedback
			$("#spinner").spin("small");

			// get Weave object
			var weave = swfobject.getObjectById("vis-{{ visualization.id|default:'new' }}");

			var params = { 
				"title": $("#.vis_properties_form form #title").val(),
				"year": $("#.vis_properties_form form #year").val(),
				"abstract": $("#.vis_properties_form form #abstract").val(), 
				"topics": JSON.stringify($(".vis_properties_form form #topics").val()),
				"datasources": JSON.stringify($(".vis_properties_form form #datasources").val()),
				"sessionstate": JSON.stringify(weave.getSessionState([])),
				"thumbnail": weave.evaluateExpression(null, 'getBase64Image(Application.application.visDesktop)', null, ['weave.utils.BitmapUtils', 'mx.core.Application']) 
			}

			// additional parameters
			if (add_params) $.extend(params, add_params);

			$.post(MBDC.visurl, 
				params,
				function(data){
					
					// set new URLs
					if (data) {
						MBDC.visembedurl = MBDC.visurl = data["visurl"];
						MBDC.visid = data["visid"];
						$("#vis-title").attr("href", data["visurl"]);
						$("#embed-code input").val("<iframe width='500' height='350' frameborder='0' scrolling='no' marginheight='0' marginwidth='0' src='{{ siteurl }}" + MBDC.visembedurl + "embed'></iframe><br /><small><a href='{{ siteurl }}" + MBDC.visembedurl + "'>View Larger Visualization</a></small>");
					}

					// more options once the visualization is saved
					$("#properties-button, #save-button, #duplicate-button, #duplicate-spacer, #embed-button, #embed-spacer, #delete-button, #delete-spacer").show();
					$("#delete-button").attr("href", MBDC.visurl + "delete");

					$("#spinner").spin(false);

				}, 
				"json"
			);
		}

		// Edit visualization properties and update text on page
		$(".vis_properties_form form #title, .vis_properties_form form #abstract, .vis_properties_form form #year").bind("keyup", function () {
			$("#vis-" + $(this).attr("id")).html($(this).val());
		});

	});

</script>

{% endblock head_javascript %}


{% block body %}

<!-- breadcrumb -->
<div class="breadcrumb">
	<span class="breadcrumb_title">You are here:</span>
    <a class="breadcrumb_link" href="/">Do-It-Yourself</a>
    
    {% if visualization.id %}
    <span class="breadcrumb_current">{{ visualization.title }}</span>
    {% else %}
    <span class="breadcrumb_current">New Weave Visualization</span>
    {% endif %}
</div>
<!-- /breadcrumb -->

{% get_data_search_bar %}
		
<!-- site_body -->
<div class="site_body">
	<div class="site_body_pad">
		
		{% if not visualization.id %}
		<!-- page_intro_content -->
		<div class="page_intro_content">
			<div class="page_content_text page_content">
				<h1>Create a new Weave visualization</h1>
			</div>
			<div class="clear"></div>
		</div>
		<!-- /page_intro_content -->
		{% endif %}
				
		<!-- data_vis -->
		<div class="data_vis">
			<div class="data_vis_pad">
				<div id="spinner"></div>
				<div class="data_vis_header">
					<div class="title"><a id="vis-title" href="{{ visualization.get_absolute_url }}">{{ visualization.title|default:"New Weave Visualization" }} </a></div>

					{% if visualization %}<div class="info">{% if visualization.owner.get_profile.get_absolute_url %}By <a href="{{ visualization.owner.get_profile.get_absolute_url }}">{% firstof visualization.owner.get_profile.name visualization.owner.username %}</a>{% else %}By {% firstof visualization.owner.get_profile.name visualization.owner.username %}{% endif %}</div>{% endif %}

					{% if visualization.original %}<div class="info">Based on <a href="{{ visualization.original.get_absolute_url }}">{{ visualization.original.title }}</a></div>{% endif %}

					<div class="info">{% if visualization.year %}Year(s): <span id="vis-year">{{ visualization.year }}</span><span class="spacer">&#8226;</span>{% endif %}  {% if related_datasources %}Source(s): <span id="vis-datasources">{% for datasource in related_datasources %}<a href="{{ datasource.url }}" target="_blank">{{ datasource.title }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</span>{% endif %}</div>
					<a href="#" id="properties-button" class="expand_link">Edit Properties [+]</a>
				</div>
				
				<div class="vis_properties_form">	
					<form>
							<div class="vis_properties_form_label"><label for="title">Title</label></div>
							<input type="text" name="title" id="title" value="{{ visualization.title|default:"New Weave Visualization" }}" class="" />
							<br />
							<div class="vis_properties_form_label"><label for="year">Year(s)</label></div>
							<input type="text" name="year" id="year" value="{{ visualization.year }}" class="" />
							<br />
							<div class="vis_properties_form_label"><label for="abstract"></label>Short description</div>
							<textarea id="abstract" name="abstract">{{ visualization.abstract }}</textarea>
							<br>
							<div class="vis_properties_form_label"><label for="topic"></label>Related topic(s)</div>
							<select id="topics" multiple="multiple">
							{% for topic in topics %}
							<option value="{{ topic.id }}" {% if topic.selected %}selected="selected"{% endif %}>{{ topic.title }}</option>
							{% endfor %}
							</select>
							<br>
							<div class="vis_properties_form_label"><label for="datasources"></label>Datasource(s)</div>
							<select id="datasources" multiple="multiple">
							{% for datasource in datasources %}
							<option value="{{ datasource.id }}" {% if datasource.selected %}selected="selected"{% endif %}>{{ datasource.title }}</option>
							{% endfor %}
							</select>

							<div>{% if user.is_authenticated %}<a id="save-properties-button" class="properties_button" href="save">Save</a>{% else %}<a class="properties_button" href="/accounts/login?next={{ request.get_full_path }}">{% trans "Login to Save Visualization" %}</a>{% endif %}</div>
					</form>
				</div>

				<div class="data_vis_nav">
					{% if user.is_authenticated %}
						<a id="save-button" title="Save this Visualization" href="save">Save</a> 
						<span id="duplicate-spacer" class="spacer">|</span> <a id="duplicate-button" title="Duplicate this Visualization to your profile" href="duplicate">Duplicate</a>
						<span id="delete-spacer" class="spacer">|</span> <a id="delete-button" title="Delete this Visualization from your profile" href="delete">Delete</a>
					{% else %}
					<a href="/accounts/login?next={{ request.get_full_path }}">{% trans "Login to Save Visualization" %}</a>
					{% endif %}
					<span id="embed-spacer" class="spacer">|</span> <a id="embed-button" href="embed" title="Embed this Visualization in another website">Embed</a>
				</div>

				<div id="embed-code">Copy&amp;paste the embed-code below into your website:<input type="text" /></div>

				<div class="data_vis_tabs">
					<div id="tabs-1" class="weave_container">
						<div id="vis-{{ visualization.id|default:'new' }}">
							{% if visualization.id %}
							<img src="{{ MEDIA_URL }}weave_thumbnails/{{ visualization.id }}.png" alt="{{ visualization.title }}">
							{% endif %}
							<p>Please install the <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to be able to interact with this visualization.</p>
						</div>
					</div>
				</div>
				<div class="data_vis_content page_content">
					<p id="vis-abstract">{{ visualization.abstract }}</p>
				</div>
				<div class="data_vis_attr">
					<img src="{{ STATIC_URL }}mbdc/img/logo-oic.png" alt="OIC" width="65" height="30" />
					powered by: <a href="http://oicweave.org/" title="Weave - Web-based Analysis and Visualization Environment">Weave</a>
				</div>
				<div class="data_vis_relations">
					<ul class="data_vis_relations_topics">

						{% for topic in related_topics %}	

						<li><a href="{{ topic.get_absolute_url }}"><span class="topic_icon topic_{{ topic.slug }}"></span>{{ topic.title }}</a></li>

						{% endfor %}

					</ul>
				</div>
				<div class="clear"></div>
			</div>
		</div>
		<!-- /data_vis -->				
	</div>
</div>
<!-- /site_body -->

{% endblock body %}